<script>
const API="https://script.google.com/macros/s/AKfycbxvUpvMuyPTNENbf0gyGjn1aKJiwOicKHyvFnYZEo94S7EeVc2KXWeE0TzX4SGK7GW9/exec";

let items = [];
let index = 0;
let auto;

// ===================
// CARGAR RECUERDOS
// ===================
async function load(){
  items = await fetch(API).then(r=>r.json());
  renderTrack();
  startAuto();
}
load();

function renderTrack(){
  const track = document.getElementById("track");
  track.innerHTML = "";

  items.forEach((it,i)=>{
    let el;
    if(it.type==="image"){
      el = document.createElement("img");
      el.src = it.url;
    }else{
      el = document.createElement("video");
      el.src = it.url;
      el.muted = true;
    }
    el.onclick = ()=>openModal(i);
    track.appendChild(el);
  });
}

// ===================
// CARRUSEL AUTO
// ===================
function startAuto(){
  clearInterval(auto);
  auto = setInterval(next,3500);
}

function next(){
  if(!items.length) return;
  index = (index+1) % items.length;
  move();
}

function prev(){
  if(!items.length) return;
  index = (index-1+items.length) % items.length;
  move();
}

function move(){
  document.getElementById("track").style.transform =
    `translateX(-${index*218}px)`;
}

// ===================
// MODAL GALER√çA
// ===================
function openGallery(){
  if(!items.length) return;
  openModal(0);
}

function openModal(i){
  index = i;
  showModal();
  document.getElementById("modal").style.display="flex";
}

function showModal(){
  const viewer = document.getElementById("viewer");
  const counter = document.getElementById("counter");
  const it = items[index];

  viewer.innerHTML = it.type==="image"
    ? `<img src="${it.url}">`
    : `<iframe src="${it.url}" allow="autoplay"></iframe>`;

  counter.innerText = `${index+1} / ${items.length}`;
}

function nextModal(){
  index = (index+1)%items.length;
  showModal();
}
function prevModal(){
  index = (index-1+items.length)%items.length;
  showModal();
}

// ===================
// SUBIR ARCHIVOS
// ===================
async function subir(){
  const input = document.getElementById("files");
  if(!input.files.length){
    alert("Selecciona al menos un archivo");
    return;
  }

  document.getElementById("overlay").style.display="flex";

  const uploads = [...input.files].map(f=>{
    return new Promise(resolve=>{
      const reader = new FileReader();
      reader.onload = async ()=>{
        await fetch(API,{
          method:"POST",
          body:JSON.stringify({
            name:f.name,
            type:f.type,
            base64:reader.result.split(",")[1]
          })
        });
        resolve();
      };
      reader.readAsDataURL(f);
    });
  });

  await Promise.all(uploads);

  input.value="";
  document.getElementById("overlay").style.display="none";
  load();
}

// ===================
// MENSAJES
// ===================
async function sendMessage(){
  const nombre = document.getElementById("nombre");
  const mensaje = document.getElementById("mensaje");

  if(!nombre.value || !mensaje.value){
    alert("Completa tu nombre y mensaje üíñ");
    return;
  }

  await fetch(API,{
    method:"POST",
    body:JSON.stringify({
      nombre:nombre.value,
      mensaje:mensaje.value
    })
  });

  nombre.value="";
  mensaje.value="";
  alert("Mensaje enviado con amor üíñ");
}

let mensajesCache=[];

async function openMessages(){
  document.getElementById("modalMensajes").style.display="flex";
  const data = await fetch(API+"?mensajes=1").then(r=>r.json());

  mensajesCache = data.sort(
    (a,b)=>new Date(b.fecha)-new Date(a.fecha)
  );

  document.getElementById("contadorMensajes").innerText =
    `üíñ ${mensajesCache.length} mensajes de amor`;

  renderMensajes(mensajesCache);
}

function cerrarMensajes(){
  document.getElementById("modalMensajes").style.display="none";
}

function renderMensajes(arr){
  const cont = document.getElementById("listaMensajes");
  cont.innerHTML="";
  arr.forEach(m=>{
    const d=document.createElement("div");
    d.className="msg"+(m.mensaje.length>120?" largo":"");
    d.innerHTML=`
      <strong>üíñ ${m.nombre}</strong>
      <div>${m.mensaje}</div>
    `;
    cont.appendChild(d);
  });
}

function filtrarMensajes(t){
  const q=t.toLowerCase();
  renderMensajes(
    mensajesCache.filter(m=>m.nombre.toLowerCase().includes(q))
  );
}
</script>
